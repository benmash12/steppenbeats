var timex;$(document).ready(function(){load_user(),$("#mtext").on({keyup:function(){""!=$(this).val()?($(this).next().attr("onclick","sendM()"),$(this).next().children().first().removeClass("fa-camera").addClass("fa-send")):($(this).next().attr("onclick","sendPic()"),$(this).next().children().first().removeClass("fa-send").addClass("fa-camera"))},change:function(){""!=$(this).val()?($(this).next().attr("onclick","sendM()"),$(this).next().children().first().removeClass("fa-camera").addClass("fa-send")):($(this).next().attr("onclick","sendPic()"),$(this).next().children().first().removeClass("fa-send").addClass("fa-camera"))}})});var supp=!1;function load_user(){null!=username()&&/^[\d]{10}$/.test(username())?socket.emit("load_user",username(),function(e){var r,a,n;e.processed?(timex=e.timex,0==e.orders.length?$("#orders").html('<p class="padten text-center overhide light-green"> You are yet to make an order.</p>'):(a=[],e.orders.forEach(function(e){ht='<div class="well padten no-bg no-border black-out">',ht+='<p class="panP light-green slim no-side-margin no-side-padding">Order ID: <span class="green thick">'+e.orderid+"</span></p>",ht+='<p class="panP light-green slim no-side-margin no-side-padding">Status: <span class="green thick">'+e.status+"</span></p>",ht+='<p class="panP light-green slim no-side-margin no-side-padding">Total: <span class="green thick">'+cur.sym+cash(e.price)+"</span></p>",ht+='<p class="panP light-green slim no-side-margin no-side-padding">Timestamp: <span class="green thick">'+e.dating+"</span></p>","pending"==e.status&&(ht+="<button onclick=\"compOrder('"+e.orderid+'\')" class="panButton dark-green-bg light-green radfive black-out">Complete Order</button>',ht+='<button onclick="cancelOrder('+e.id+",'"+e.orderid+'\')" class="panButton dred-bg light-green radfive black-out">Cancel Order</button>'),"successful"==e.status&&(ht+="<button onclick=\"accessDownloads('"+e.orderid+'\')" class="panButton dark-green-bg light-green radfive black-out">Acess Downloads</button>',ht+="<button onclick=\"link('/licensing/?orderid="+e.orderid+'\')" class="panButton dark-green-bg light-green radfive black-out">Download License</button>'),ht+="</div>",a.push(ht)}),$("#orders").html(a.join(""))),0==e.support.length?$("#mholder").html('<p class="panP text-center grey padten">You have no previous conversation.</p>'):(r=e.support.reverse(),a=[],n=[],r.forEach(function(e,s){var t;0==e.seen&&"send"==e.type&&n.push(1),"receive"==e.type?"text"==e.message_type?(t='<div  ondblclick="deleteMessage('+e.id+',this)" class="msx"><div><p>'+entities(e.message)+"</p><small>"+inbox_icon(e.seen,e.type)+" "+e.dating+"</small></div></div>",a.push(t)):"picture"==e.message_type&&(t='<div class="msp"><div class="msp-box"><div class="msp-box-top"><i class="fa fa-picture-o"></i></div><div class="msp-box-bottom"><button  data-picture="'+e.message+'" onclick="picture(this)"><i class="fa fa-eye"></i></button><button  onclick="deletePicture('+e.id+',this)"><i class="fa fa-trash"></i></button></div></div></div>',a.push(t)):"send"==e.type&&(t='<div class="mrs">',0!=s&&r[s-1].type==e.type?t+='<div class="mrs-img op0 img-circle img_container"><img src="/img/support.png" class="img_res"></div>':t+='<div class="mrs-img img-circle img_container"><img src="/img/support.png" class="img_res"></div>',"picture"==e.message_type?t+='<div class="msp-box"><div class="msp-box-top"><i class="fa fa-picture-o"></i></div><div class="msp-box-bottom"><button data-picture="'+e.message+'" onclick="picture(this)"><i class="fa fa-eye"></i></button></div></div>':t+='<div class="mrs-det"><p>'+entities(e.message)+"</p><small>"+e.dating+"</small></div>",t+="</div>",a.push(t))}),$("#mholder").html(a.join("")),$("#mholder").scrollTop(1e10),0==n.length?$("#supportCount").html(""):$("#supportCount").html(n.length)),supp||($("#mholder").scrollTop($("#mholder")[0].scrollHeight),supp=!0),img_res()):e.fraud?(preloader(1),window.location="/account/logout/1"):Err("An error was encountered while updating the contents of this page. You might want to reload this page to correct the error.")}):(preloader(1),window.location="/account/logout/1")}function compOrder(e){preloader(1),socket.emit("relocate_cart_378u344",e,username(),function(e){e.succ?(checkForStorage()&&(localStorage.setItem("cart",e.cart),localStorage.setItem("cartlu",e.cartlu)),window.location="/cart"):(preloader(0),Err(e.message))})}function accessDownloads(s){$.ajax({url:"/create-order-session-hbu383",type:"POST",data:{oid:s,uid:username(),_csrf:csrfx},error:function(e){preloader(0),Err("An error occurred... Please try again.")},success:function(e){e.succ?window.location="/order/"+s:(preloader(0),Err(e.message))}})}function cancelOrder(s,t){Confirm("Are you sure you want to cancel this order?",function(e){e&&(preloader(1),socket.emit("cancel_order_hb348u94334",s,t,function(e){e.succ?(preloader(0),Succ("Order has been cancelled."),load_user()):(preloader(0),Err("Sorry, An error was encountered!"))}))})}function deleteMessage(s,e){""!=username()&&Confirm("Are you sure you want to delete this message?",function(e){e&&socket.emit("delete_message",s,username(),function(e){e.succ?Succ("Message deleted successfully!"):Err("Deletion failed")})},!1)}function deletePicture(s,e){""!=username()&&Confirm("Are you sure you want to delete this picture?",function(e){e&&socket.emit("delete_message",s,username(),function(e){e.succ?Succ("Picture deleted successfully!"):Err("Deletion failed")})},!1)}function inbox_icon(e,s){return"0"==e&&"receive"==s?'<i class="fa fa-check"></i>':"1"==e&&"receive"==s?'<i class="fa fa-check"></i><i class="fa fa-check"></i>':"send"==s?'<i class="fa fa-reply"></i>':""}function sendM(){var e,s,t=$("#mtext").val();""!=t&&""!=t.replace(/[\n\t\s]/g,"")?""!=(e=username())?(s='<div class="msx"><div><p>'+entities(t)+'</p><small><i class="fa fa-spinner fa-pulse"></i> sending...</small></div></div>',$("#mholder").append(s),$("#mtext").val(""),(s={}).uid=e,s.message=t,s.message_type="text",s.type="receive",socket.emit("admin_send_message",s,function(e){e.succ?($("#sendBtnxx").attr("onclick","sendPic()"),$("#sendBtnxx").children().first().removeClass("fa-send").addClass("fa-camera")):(e.message?Err(e.message):Err("An unrecognized error occured"),$("#mholder").children().last().detach(),$("#mtext").val(t))}),$("#mholder").scrollTop($("#mholder")[0].scrollHeight)):Err("You cannot send this message"):Err("You cannot send an empty message")}function sendPic(){var t=username();""!=t?initUpload({title:"send a picture (2MB max file size)",uploadType:"sendPicture",accept:"image",acceptAttr:"image/jpeg, image/png",max:2e6,callback:function(e){e.succ?(e=e.message,preloader(1),socket.emit("upload_to_cloud",e,function(e){var s;preloader(0),e.succ?(s=e.message,(e={}).uid=t,e.message=s,e.message_type="picture",e.type="receive",socket.emit("admin_send_message",e,function(e){e.succ||(e.message?Err(e.message):(Err("An unrecognized error occured"),setTimeout(function(){$("#mholder").scrollTop($("#mholder")[0].scrollHeight)},500)))})):Err("Error uploading picture to cloud")})):Err("Image upload failed")}}):Err("You cannot perform this action")}function minfo(){Info("Double click on your messages to delete them.")}function userSeen(){socket.emit("user_seen",username()),$("#supportCount").html("")}function userSettings(){dia({title:"Preferences",html:'<div><button class="panButton dark-green-bg white black-out radfive" onclick="bootbox.hideAll();updatePassword()">Change Password</button> <button class="panButton red-bg white black-out radfive" onclick="bootbox.hideAll();deleteAccx()">Delete Account</button></div>'})}function deleteAccx(){Confirm("Are you sure about this?",function(e){e&&Info("Only admin can delete user accounts. To delete your account, inform the admin through 'Chat With Admin(Support)' tab")},!1)}function updatePassword(){bootbox.prompt({title:"Type in new password. New password must contain at least a letter, a number and must be between 8 to 30 characters long. And must not contain spaces.",inputType:"password",required:!0,callback:function(e){var s;e&&(/^(?=.*[A-Za-z])(?=.*\d)[A-Za-z\d!$%@#£€*?&]{8,30}$/.test(e)?((s={}).npw=e,bootbox.prompt({title:"Confirm Password(Type in new password again)",inputType:"password",required:!0,callback:function(e){e&&(e!==s.npw?Err("Passwords do not match!"):bootbox.prompt({title:"Type in your current password to authorise you to perform this action.",inputType:"password",required:!0,callback:function(e){e&&(s.opw=e,preloader(1),socket.emit("user_update_password",username(),s,function(e){preloader(0),e.succ?Succ("Password changed successfully!"):e.message?Err(e.message):Err("An unrecognised error occured.")}))}}))}})):Err("Password is weak! Please follow instructions."))}})}socket.on("user",function(){load_user()});